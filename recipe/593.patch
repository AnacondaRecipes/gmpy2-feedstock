From b8b258d36b5b4be3ed314711e47addabcba9860a Mon Sep 17 00:00:00 2001
From: Sergey B Kirpichev <skirpichev@gmail.com>
Date: Mon, 22 Sep 2025 07:48:54 +0300
Subject: [PATCH] Adjust to_bytes() behavior to match CPython

See python/cpython#71810
---
 src/gmpy2_mpz_misc.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/src/gmpy2_mpz_misc.c b/src/gmpy2_mpz_misc.c
index 4804c3e7..b2f95d93 100644
--- a/src/gmpy2_mpz_misc.c
+++ b/src/gmpy2_mpz_misc.c
@@ -1985,7 +1985,12 @@ GMPy_MPZ_Method_To_Bytes(PyObject *self, PyObject *const *args,
     gap = length - size;
 
     if (gap < 0 || sign < 0 ||
-        (is_signed && length && mpz_tstbit(*px, 8*length - 1) == !is_negative))
+        (is_signed &&
+#if (PY_VERSION_HEX < 0x030D08F0 || (PY_VERSION_HEX >= 0x030E0000 \
+                                     && PY_VERSION_HEX < 0x030E00C3))
+         length &&
+#endif
+         mpz_tstbit(*px, 8*length - 1) == !is_negative))
     {
         OVERFLOW_ERROR("mpz too big to convert");
         return NULL;
